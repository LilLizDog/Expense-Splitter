<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Expense Splitter - Add Expense</title>

  <!--
    Add Expense page
    - Shell, typography, and components match the dashboard for consistency.
    - Sidebar is collapsed by default and opens via the hamburger checkbox.
    - Members field uses a compact dropdown with checkboxes (search + select all).
  -->

  <style>
    :root{
      /* Theme — copied from dashboard */
      --green: #16a34a;
      --green-600: #15803d;
      --red: #b91c1c;
      --black: #111111;
      --bg: #f6f7f8;
      --card: #ffffff;
      --muted: #6b7280;

      /* Layout — copied from dashboard */
      --sidebar-w: 220px;
      --radius: 14px;
      --shadow: 0 8px 20px rgba(0,0,0,0.06);
      --content-max: 1120px;
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--black);
      font-family: Arial, Helvetica, sans-serif;
      font-size: 15px;
      line-height: 1.35;
    }

    /* ───────────────────────────────── Top bar (identical to dashboard) */
    .topbar{
      position: sticky; top:0; z-index: 40;
      height: 56px;
      background: #fff;
      box-shadow: var(--shadow);
      display:flex; align-items:center; gap:12px;
      padding: 0 14px;
    }
    .brand{ font-weight: 800; font-size: 1.6rem; letter-spacing: .2px; }
    .brand .accent{ color: var(--green); }

    /* ───────────────────────────────── Shell */
    .layout{ display:block; min-height: calc(100dvh - 56px); }

    /* Hamburger + toggle */
    #nav-toggle{ display:none; }
    .hamburger{ width:26px; height:20px; cursor:pointer; display:grid; gap:5px; }
    .hamburger span{ display:block; height:3px; background:var(--black); border-radius:2px; }

    /* Sidebar (collapsed by default) */
    .sidebar{
      position: fixed; left:0; top:56px; z-index: 50;
      width: 0; padding:0;
      height: calc(100dvh - 56px);
      background:#fff;
      box-shadow: var(--shadow);
      overflow: hidden;
      transform: translateX(-100%);
      transition: transform .25s ease, width .25s ease, padding .25s ease;
    }
    #nav-toggle:checked ~ .layout .sidebar{
      transform: translateX(0);
      width: var(--sidebar-w);
      padding: 14px;
    }

    .nav-title{ font-size:.85rem; color:var(--muted); margin: 6px 8px 10px; }
    .nav{ display:flex; flex-direction: column; gap:6px; }
    .nav a{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:10px; text-decoration:none;
      color:var(--black); font-size:14px;
    }
    .nav a:hover{ background:#f1f5f9; }
    .nav a.active{ background:#e8f8ee; color:var(--green-600); font-weight:600; }
    .nav a svg{ width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:2; flex:0 0 18px; }

    /* ───────────────────────────────── Main content */
    .main{ padding:20px; max-width:var(--content-max); margin-inline:auto; }
    .panel{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    h1{ margin:0 0 8px; font-size:1.5rem; }
    .muted{ color: var(--muted); }

    /* ───────────────────────────────── Form controls */
    label{ font-weight:600; display:block; margin:10px 0 6px; }
    input, select, textarea{
      width:100%; padding:10px 12px; font-size:14px;
      border:1px solid #e5e7eb; border-radius:12px; outline:none; background:#fff;
    }
          /* Currency input styling */
      .money-field {
        position: relative;
      }

      .money-field .prefix {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        font-weight: 600;
      }

      .money-field input {
        padding-left: 28px; /* space for the $ */
        -moz-appearance: textfield;
      }

      .money-field input::-webkit-outer-spin-button,
      .money-field input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

    input:focus, select:focus, textarea:focus{ border-color:#d1d5db; box-shadow: var(--shadow); }

    .actions{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      border:1px solid #e5e7eb; background:#fff; border-radius:12px;
      padding:9px 12px; text-decoration:none; color:var(--black); font-weight:600;
      box-shadow: var(--shadow); font-size:14px; cursor:pointer;
    }
    .btn:hover{ border-color:#d1d5db; }
    .btn.primary{ background:#e8f8ee; color:var(--green-600); border-color:#cdebdc; }

        /* Split type + error text */
    .split-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .split-row label{
      font-weight:400;
      margin:0;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .split-row input[type="radio"]{
      margin:0;
    }
    .error-text{
      color:var(--red);
      font-size:0.85rem;
      margin-top:4px;
      display:none;
    }
    .req{
      color:var(--red);
    }

    /* ───────────────────────────────── Members dropdown (compact multi-select) */
    .dd-btn{
      width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px;
      background:#fff; text-align:left; cursor:pointer; font-size:14px;
    }
    .dd-btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .dd-panel{
      margin-top:8px; border:1px solid #e5e7eb; background:#fff; border-radius:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08); padding:10px;
    }
    .dd-head{ display:flex; gap:10px; align-items:center; margin-bottom:8px; }
    .dd-check{
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      flex:0 0 auto;        /* don't let this item shrink */
      white-space:nowrap;   /* keep "Select all" on one line */
    }
    .dd-check input[type="checkbox"]{
      margin:0 6px 0 2px;   /* tidy spacing */
    }

    .dd-search{
      flex:1 1 auto;        /* grow and shrink to use remaining space */
      min-width:0;          /* allow proper shrinking without wrapping .dd-check */
      padding:8px 10px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      font-size:14px;
    }

   .dd-list{
      /* list is a left-aligned vertical stack; no centering */
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      max-height:240px;
      overflow:auto;
      padding:6px 2px;
      text-align:left;
    }

    .dd-item{
      /* compact row that does NOT stretch full width */
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:8px;
      cursor:pointer;
      justify-content:flex-start;
      width:max-content;          
      max-width:100%;
    }
    .dd-item:hover{ background:#f3f4f6; }
    /* tighten checkbox + name */
    .dd-item input[type="checkbox"]{ margin:0 8px 0 2px; }
    .dd-item span{ flex:0 0 auto; display:inline-block; }


    .dd-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }
    .dd-primary{ padding:8px 12px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; }
    .dd-link{ background:transparent; border:none; color:#6B7280; padding:8px; cursor:pointer; }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <!-- ───────────────────────────────── Top bar -->
  <header class="topbar">
    <label for="nav-toggle" class="hamburger" title="Menu">
      <span></span><span></span><span></span>
    </label>
    <div class="brand">Expense <span class="accent">Splitter</span></div>
  </header>

  <!-- Sidebar toggle (unchecked by default => collapsed) -->
  <input id="nav-toggle" type="checkbox"/>

  <div class="layout">
    <!-- ───────────────────────────────── Sidebar navigation -->
    <aside class="sidebar">
      <div class="nav-title">Menu</div>
      <nav class="nav">
        <a href="/dashboard">
          <svg viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5v9a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z"/></svg>
          Home
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M20 20l-3.5-3.5"/></svg>
          Search
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><path d="M7 20a4 4 0 1 1 10 0"/><circle cx="12" cy="8" r="3"/><path d="M2 20a4 4 0 0 1 6-3.46"/><path d="M22 20a4 4 0 0 0-6-3.46"/></svg>
          Groups
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><path d="M2 20a6 6 0 0 1 12 0"/><path d="M10 20a6 6 0 0 1 12 0"/></svg>
          Friends
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 3-6.7"/><path d="M3 3v6h6"/><path d="M12 7v6l4 2"/></svg>
          History
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><path d="M3 7h14a4 4 0 0 1 4 4v2a4 4 0 0 1-4 4H3z"/><path d="M17 11h4v2h-4z"/></svg>
          Wallet
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><path d="M6 8a6 6 0 1 1 12 0v5l2 3H4l2-3z"/><path d="M9 19a3 3 0 0 0 6 0"/></svg>
          Notifications
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a2 2 0 0 1-2.9 2.9l-.1-.1a1 1 0 0 0-1.1-.2 1 1 0 0 0-.6.9V21a2 2 0 0 1-4 0v-.1a1 1 0 0 0-.6-.9 1 1 0 0 0-1.1.2l-.1.1a2 2 0 1 1-2.9-2.9l.1-.1a1 1 0 0 0 .2-1.1 1 1 0 0 0-.9-.6H3a2 2 0 0 1 0-4h.1a1 1 0 0 0 .9-.6 1 1 0 0 0-.2-1.1l-.1-.1a2 2 0 1 1 2.9-2.9l.1.1a1 1 0 0 0 1.1.2h.1c.5-.2.8-.6.8-1.1V3a2 2 0 0 1 4 0v.1c0 .5.3.9.8 1.1h.1a1 1 0 0 0 1.1-.2l.1-.1a2 2 0 1 1 2.9 2.9l-.1.1a1 1 0 0 0-.2 1.1v.1c.2.5.6.8 1.1.8H21a2 2 0 0 1 0 4h-.1a1 1 0 0 0-.9.6z"/></svg>
          Settings
        </a>
        <a class="active" href="/add-expense">
          <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          Add Expense
        </a>
      </nav>
    </aside>

    <!-- ───────────────────────────────── Main content -->
    <main class="main">
      <section class="panel" style="max-width: 920px; margin-inline:auto;">
        <h1>Add Expense</h1>
        <p class="muted">Enter details below to add a new expense.</p>

        <!--
          FORM
          - Groups are fetched from /groups.
          - Members are fetched from /groups/:id/members and shown in a dropdown multi-select.
          - Selected member IDs are mirrored into hidden inputs (name="member_ids") for form submission.
        -->
        <form id="expenseForm" onsubmit="return false;">
          <!-- Group -->
          <label for="group">Group <span class="req">*</span></label>
          <select id="group" name="group" required>
            <option value="" disabled selected>Select a group...</option>
          </select>

          <!-- Members (Dropdown Multi-select) -->          
           <label for="memberBtn" style="margin-top:12px;">Members <span class="req">*</span></label>

          <button id="memberBtn" class="dd-btn" type="button" disabled aria-expanded="false">
            Choose a group first.
          </button>

          <div id="memberPanel" class="dd-panel hidden" role="dialog" aria-label="Select members">
            <div class="dd-head">
              <label class="dd-check">
                <input type="checkbox" id="memberSelectAll" />
                <span>Select all</span>
              </label>
              <input id="memberSearch" class="dd-search" type="text" placeholder="Search members…">
            </div>

            <div id="memberList" class="dd-list" role="listbox" aria-multiselectable="true">
              <!-- Member items injected here -->
            </div>

            <div class="dd-actions">
              <button type="button" id="memberDone" class="dd-primary">Done</button>
              <button type="button" id="memberClear" class="dd-link">Clear</button>
            </div>
          </div>

          <!-- Hidden container where checked member IDs are mirrored as inputs -->
          <div id="memberHiddenInputs" class="hidden"></div>

          <!-- Split type --> 
          <label>Split Type <span class="req">*</span></label>

          <div class="split-row">
            <label>
              <input type="radio" name="split_type" value="equal" checked />
              <span>Equal</span>
            </label>
            <label>
              <input type="radio" name="split_type" value="amount" />
              <span>Custom amounts</span>
            </label>
            <label>
              <input type="radio" name="split_type" value="percentage" />
              <span>Custom percentages</span>
            </label>
          </div>
          <div id="splitError" class="error-text"></div>

          <!-- Custom amounts (per member) -->
          <div id="customAmountSection" class="hidden" style="margin-top:8px;">
            <div class="muted" style="font-size:0.9rem; margin-bottom:4px;">
              Enter each member&rsquo;s share in dollars. Total cannot exceed the amount.
            </div>
            <div id="customAmountRows"></div>
          </div>

          <!-- Custom percentages (per member) -->
          <div id="customPercentageSection" class="hidden" style="margin-top:8px;">
            <div class="muted" style="font-size:0.9rem; margin-bottom:4px;">
              Enter each member&rsquo;s share in percent. All percentages must add up to 100.
            </div>
            <div id="customPercentageRows"></div>
          </div>

          <!-- Amount, description, date -->          
          <label for="total">Total Amount <span class="req">*</span></label>

          <div class="money-field">
            <span class="prefix" aria-hidden="true">$</span>
            <input id="total" name="total" type="number" step="0.01" inputmode="decimal"
                  placeholder="0.00"
                  aria-label="Total amount in US dollars" required />
          </div>
          <label for="description">Description (optional)</label>
          <input id="description" name="description" type="text" placeholder="e.g. Pizza Night" />
          <label for="date">Date <span class="req">*</span></label>
          <input id="date" name="date" type="date" required />

          <!-- Actions -->
          <div class="actions">
            <button class="btn primary" disabled>Save Expense</button>
          </div>
        </form>
      </section>
    </main>
  </div>

  <!--
    Scripts
    - Dependency-free.
    - Robust to response shapes: accepts either array ([...]) or object with "data" ([...]).
    - Endpoints assumed:
        GET /groups
        GET /groups/:id/members
  -->
  <script>
    /* ───────────────────────────────── Utility: today as default date */
    (function presetToday(){
      const d = document.getElementById('date');
      if (!d) return;
      const t = new Date();
      const mm = String(t.getMonth() + 1).padStart(2, '0');
      const dd = String(t.getDate()).padStart(2, '0');
      d.value = `${t.getFullYear()}-${mm}-${dd}`;
    })();

    /* ───────────────────────────────── Fetch helpers */
    async function fetchJson(url){
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return res.json();
    }
    function normalizeRows(payload){
      // Accepts [ ... ] or { data: [ ... ] } and returns an array.
      return Array.isArray(payload) ? payload : (Array.isArray(payload?.data) ? payload.data : []);
    }

    /* ───────────────────────────────── Populate Group dropdown */
    (async function loadGroups(){
      const sel = document.getElementById('group');
      const addOpt = (value, label, disabled=false) => {
        const o = document.createElement('option');
        o.value = value; o.textContent = label; o.disabled = disabled;
        sel.appendChild(o);
      };
      try{
        const data = normalizeRows(await fetchJson('/groups'));
        if (!data.length){ addOpt('', 'No groups found', true); sel.value=''; sel.disabled=true; return; }
        data.forEach(g=>{
          const id = g.id ?? g.group_id ?? g.uuid ?? g.pk;
          const name = g.name ?? g.group_name ?? g.title ?? `Group ${id}`;
          if (id != null) addOpt(String(id), String(name));
        });
      }catch(err){
        console.error('Failed to load groups:', err);
        addOpt('', 'Error loading groups', true); sel.value=''; sel.disabled=true;
      }
    })();

    /* ───────────────────────────────── Members dropdown logic */
    (function membersDropdown(){
      // Elements
      const groupSel   = document.getElementById('group');
      const btn        = document.getElementById('memberBtn');
      const panel      = document.getElementById('memberPanel');
      const list       = document.getElementById('memberList');
      const search     = document.getElementById('memberSearch');
      const selectAll  = document.getElementById('memberSelectAll');
      const done       = document.getElementById('memberDone');
      const clear      = document.getElementById('memberClear');
      const hiddenWrap = document.getElementById('memberHiddenInputs');      
      const customAmountSection = document.getElementById('customAmountSection');
      const customPercentageSection = document.getElementById('customPercentageSection');
      const customAmountRows = document.getElementById('customAmountRows');
      const customPercentageRows = document.getElementById('customPercentageRows');
      const splitRadios = document.querySelectorAll('input[name="split_type"]');


      // State
      let currentMembers = [];   // [{id, name}]
      let open = false;

      // Accessors
      function getCheckedIds(){
        return [...list.querySelectorAll('.memberChk:checked')].map(c=>c.value);
      }
      function setCheckedByIds(ids){
        const idSet = new Set(ids.map(String));
        list.querySelectorAll('.memberChk').forEach(c => { c.checked = idSet.has(c.value); });
        syncSelectAll();
        syncSummary();
        mirrorHiddenInputs();
      }
      // Rendering
      function renderMembers(rows){
        currentMembers = rows.map(m => ({
          id: String(m.id ?? m.member_id ?? m.user_id),
          name: String(m.name ?? m.full_name ?? m.username ?? `User ${m.id ?? m.member_id ?? m.user_id}`)
        })).filter(m => m.id !== 'null' && m.id !== 'undefined');

        list.innerHTML = currentMembers.map(m => `
          <label class="dd-item">
            <input type="checkbox" class="memberChk" value="${m.id}" />
            <span>${m.name}</span>
          </label>
        `).join('') || `<div class="muted" style="padding:8px;">No members in this group.</div>`;

        selectAll.checked = false;
        syncSummary();
        mirrorHiddenInputs(); // reset hidden inputs
        buildCustomRows();
      }
      
      function buildCustomRows() {
        if (!customAmountRows || !customPercentageRows) return;

        if (!currentMembers.length) {
          customAmountRows.innerHTML = '';
          customPercentageRows.innerHTML = '';
          return;
        }

        // Custom amount inputs: $ per member
        customAmountRows.innerHTML = currentMembers.map(m => `
          <div style="margin-top:6px;">
            <label style="margin:0 0 2px;">${m.name}</label>
            <div class="money-field">
              <span class="prefix" aria-hidden="true">$</span>
              <input
                type="number"
                class="custom-amount-input"
                data-member-id="${m.id}"
                step="0.01"
                min="0"
                inputmode="decimal"
                placeholder="0.00"
              />
            </div>
          </div>
        `).join('');

        // Custom percentage inputs: % per member
        customPercentageRows.innerHTML = currentMembers.map(m => `
          <div style="margin-top:6px;">
            <label style="margin:0 0 2px;">${m.name}</label>
            <div style="display:flex; align-items:center; gap:6px;">
              <input
                type="number"
                class="custom-percentage-input"
                data-member-id="${m.id}"
                step="0.01"
                min="0"
                max="100"
                inputmode="decimal"
                placeholder="0"
                style="width:120px;"
              />
              <span>%</span>
            </div>
          </div>
        `).join('');
      }

      function updateSplitSections() {
        const selected = [...splitRadios].find(r => r.checked)?.value || 'equal';
        if (customAmountSection) {
          customAmountSection.classList.toggle('hidden', selected !== 'amount');
        }
        if (customPercentageSection) {
          customPercentageSection.classList.toggle('hidden', selected !== 'percentage');
        }
      }

      // Hidden inputs mirror (for normal form post)
      function mirrorHiddenInputs(){
        hiddenWrap.innerHTML = '';
        getCheckedIds().forEach(id => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'member_ids';
          input.value = id;
          hiddenWrap.appendChild(input);
        });
      }

      // Summary on the button (e.g., "3 selected")
      function syncSummary(){
        const count = getCheckedIds().length;
        btn.textContent = count ? `${count} selected` : 'Select members';
      }

      // Keep "Select all" in sync with individual changes
      function syncSelectAll(){
        const checks = [...list.querySelectorAll('.memberChk')];
        selectAll.checked = checks.length > 0 && checks.every(c=>c.checked);
      }

      // Open/close panel
      function openPanel(){
        panel.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); open = true;
        setTimeout(()=>search.focus(), 0);
      }
      function closePanel(){
        panel.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); open = false;
      }

      // Fetch members for selected group
      async function loadMembersFor(groupId){
        list.innerHTML = `<div class="muted" style="padding:8px;">Loading members…</div>`;
        selectAll.checked = false;
        try{
          const rows = normalizeRows(await fetchJson(`/groups/${groupId}/members`));
          renderMembers(rows);
        }catch(err){
          console.error('Failed to load members:', err);
          list.innerHTML = `<div class="muted" style="padding:8px;">Error loading members.</div>`;
        }
      }

      // ── Wire: group change → enable dropdown and fetch members
      groupSel.addEventListener('change', (e)=>{
        const gid = e.target.value;
        if (!gid){ btn.disabled = true; btn.textContent = 'Choose a group first.'; return; }
        btn.disabled = false; btn.textContent = 'Select members';
        closePanel();
        loadMembersFor(gid);
      });

      // ── Wire: open/close
      btn.addEventListener('click', ()=> open ? closePanel() : openPanel());
      document.addEventListener('click', (e)=>{
        if (!open) return;
        if (e.target === btn || panel.contains(e.target)) return;
        closePanel();
      });
      document.addEventListener('keydown', (e)=>{ if (open && e.key === 'Escape') closePanel(); });

      // ── Wire: search filter
      search.addEventListener('input', ()=>{
        const q = search.value.toLowerCase();
        [...list.querySelectorAll('.dd-item')].forEach(item=>{
          const name = item.textContent.toLowerCase();
          item.style.display = name.includes(q) ? '' : 'none';
        });
      });

      // ── Wire: select all
      selectAll.addEventListener('change', ()=>{
        list.querySelectorAll('.memberChk').forEach(c => c.checked = selectAll.checked);
        syncSummary();
        mirrorHiddenInputs();
      });

      // ── Wire: individual checks
      list.addEventListener('change', (e)=>{
        if (!e.target.classList.contains('memberChk')) return;
        syncSelectAll();
        syncSummary();
        mirrorHiddenInputs();
      });

      // ── Wire: actions
      clear.addEventListener('click', ()=>{
        setCheckedByIds([]); // uncheck all and sync
      });
      done.addEventListener('click', closePanel);

      // ── Wire: split type toggle
      splitRadios.forEach(radio => {
        radio.addEventListener('change', updateSplitSections);
      });
      updateSplitSections(); // initial state (equal = hide both)
    })();


/* ───────────────────────────────── Add Expense submit wiring (mock)
   - Wires the Save button.
   - Validates required fields and selected members.
   - Calls POST /expenses with JSON payload.
   - On success: alert, reset UI, redirect to /dashboard.
*/
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('expenseForm');
  const saveBtn = document.querySelector('.btn.primary'); // same class used in markup
  const memberHidden = document.getElementById('memberHiddenInputs');
  const memberBtn = document.getElementById('memberBtn');

  if (!form || !saveBtn) return;

  // enable the Save button now that the endpoint exists
  saveBtn.disabled = false;

  form.addEventListener('submit', async function (e) {
    e.preventDefault(); // prevent default form navigation

    // read required fields
    const groupEl = document.getElementById('group');
    const amountEl = document.getElementById('total');
    const descEl = document.getElementById('description');
    const dateEl = document.getElementById('date');

    const group_id = parseInt((groupEl?.value || '0'), 10);
    const amount = parseFloat((amountEl?.value || '0'));
    const description = (descEl?.value || '').trim();
    const expense_date = dateEl?.value || '';

    // collect selected members mirrored as hidden inputs (name="member_ids")
    const member_ids = memberHidden
      ? [...memberHidden.querySelectorAll('input[name="member_ids"]')].map(i => parseInt(i.value, 10))
      : [];

    // temporary payer until auth is wired
    const payer = 'Preet';

    // minimal validation    
    if (!group_id || !amount || !expense_date || member_ids.length === 0) {
      alert('Please fill all required fields and select at least one member.');
      return;
    }


    // basic submit UX
    saveBtn.disabled = true;
    const oldLabel = saveBtn.textContent;
    saveBtn.textContent = 'Saving…';

    try {
      const res = await fetch('/expenses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ group_id, payer, amount, description, expense_date, member_ids })
      });
      const json = await res.json().catch(() => ({}));

      if (!res.ok || !json?.ok) {
        const msg = json?.detail || json?.error || `Save failed (${res.status}).`;
        throw new Error(msg);
      }

      alert('Expense created!');
      // reset form and member UI
      form.reset();
      if (memberHidden) memberHidden.innerHTML = '';
      if (memberBtn) memberBtn.textContent = 'Select members';

      // redirect to dashboard
      window.location.href = '/dashboard';
    } catch (err) {
      console.error(err);
      alert(err.message || 'Save failed. Please try again.');
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = oldLabel;
    }
  });
});
  </script>
</body>
</html>