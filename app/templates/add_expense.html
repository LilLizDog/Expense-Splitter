<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Expense Splitter - Add Expense</title>

  <style>
    :root{
      --green: #16a34a;
      --green-600: #15803d;
      --red: #b91c1c;
      --orange: #f97316;
      --black: #111111;
      --bg: #f6f7f8;
      --card: #ffffff;
      --muted: #6b7280;

      --sidebar-w: 220px;
      --radius: 14px;
      --shadow: 0 8px 20px rgba(0,0,0,0.06);
      --content-max: 1120px;
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--black);
      font-family: Arial, Helvetica, sans-serif;
      font-size: 15px;
      line-height: 1.35;
    }

    .topbar{
      position: sticky; top:0; z-index: 40;
      height: 56px;
      background: #fff;
      box-shadow: var(--shadow);
      display:flex; align-items:center; gap:12px;
      padding: 0 14px;
    }
    .brand{ font-weight: 800; font-size: 1.6rem; letter-spacing: .2px; }
    .brand .accent{ color: var(--green); }

    .layout{ display:block; min-height: calc(100dvh - 56px); }

    #nav-toggle{ display:none; }
    .hamburger{ width:26px; height:20px; cursor:pointer; display:grid; gap:5px; }
    .hamburger span{ display:block; height:3px; background:var(--black); border-radius:2px; }

    .sidebar{
      position: fixed; left:0; top:56px; z-index: 50;
      width: 0; padding:0;
      height: calc(100dvh - 56px);
      background:#fff;
      box-shadow: var(--shadow);
      overflow: hidden;
      transform: translateX(-100%);
      transition: transform .25s ease, width .25s ease, padding .25s ease;
    }
    #nav-toggle:checked ~ .layout .sidebar{
      transform: translateX(0);
      width: var(--sidebar-w);
      padding: 14px;
    }

    .nav-title{ font-size:.85rem; color:var(--muted); margin: 6px 8px 10px; }
    .nav{ display:flex; flex-direction: column; gap:6px; }
    .nav a{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:10px; text-decoration:none;
      color:var(--black); font-size:14px;
    }
    .nav a:hover{ background:#f1f5f9; }
    .nav a.active{ background:#e8f8ee; color:var(--green-600); font-weight:600; }
    .nav a svg{ width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:2; flex:0 0 18px; }

    .main{ padding:20px; max-width:var(--content-max); margin-inline:auto; }
    .panel{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    h1{ margin:0 0 8px; font-size:1.5rem; }
    .muted{ color: var(--muted); }

    label{ font-weight:600; display:block; margin:10px 0 6px; }
    input, select, textarea{
      width:100%; padding:10px 12px; font-size:14px;
      border:1px solid #e5e7eb; border-radius:12px; outline:none; background:#fff;
    }

    .money-field {
      position: relative;
    }
    .money-field .prefix {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-weight: 600;
    }
    .money-field input {
      padding-left: 28px;
      -moz-appearance: textfield;
    }
    .money-field input::-webkit-outer-spin-button,
    .money-field input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input:focus, select:focus, textarea:focus{
      border-color:#d1d5db; box-shadow: var(--shadow);
    }

    .actions{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:1px solid #e5e7eb; background:#fff; border-radius:12px;
      padding:9px 12px; text-decoration:none; color:var(--black); font-weight:600;
      box-shadow: var(--shadow); font-size:14px; cursor:pointer;
    }
    .btn[disabled]{
      opacity:0.6;
      cursor:not-allowed;
    }
    .btn:hover{ border-color:#d1d5db; }
    .btn.primary{ background:#e8f8ee; color:var(--green-600); border-color:#cdebdc; }

    .split-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .split-row label{
      font-weight:400;
      margin:0;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .split-row input[type="radio"]{
      margin:0;
    }

    .error-text{
      color:var(--red);
      font-size:0.85rem;
      margin-top:4px;
      display:none;
    }
    .req{
      color:var(--red);
    }

    .dd-btn{
      width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px;
      background:#fff; text-align:left; cursor:pointer; font-size:14px;
    }
    .dd-btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .dd-panel{
      margin-top:8px; border:1px solid #e5e7eb; background:#fff; border-radius:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08); padding:10px;
    }
    .dd-head{ display:flex; gap:10px; align-items:center; margin-bottom:8px; }
    .dd-check{
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .dd-check input[type="checkbox"]{
      margin:0 6px 0 2px;
    }

    .dd-search{
      flex:1 1 auto;
      min-width:0;
      padding:8px 10px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      font-size:14px;
    }

    .dd-list{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      max-height:240px;
      overflow:auto;
      padding:6px 2px;
      text-align:left;
    }

    .dd-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:8px;
      cursor:pointer;
      justify-content:flex-start;
      width:max-content;
      max-width:100%;
    }
    .dd-item:hover{ background:#f3f4f6; }
    .dd-item input[type="checkbox"]{ margin:0 8px 0 2px; }
    .dd-item span{ flex:0 0 auto; display:inline-block; }

    .dd-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }
    .dd-primary{ padding:8px 12px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; }
    .dd-link{ background:transparent; border:none; color:#6B7280; padding:8px; cursor:pointer; }

    .hidden{ display:none !important; }

    .status-badge{
      font-size:0.85rem;
      margin-top:4px;
      font-weight:600;
      display:none;
    }
    .status-badge.under{
      color:var(--red);
    }
    .status-badge.over{
      color:var(--orange);
    }
  </style>
</head>

<body>

  <header class="topbar">
    <label for="nav-toggle" class="hamburger" title="Menu">
      <span></span><span></span><span></span>
    </label>
    <div class="brand">Expense <span class="accent">Splitter</span></div>
  </header>

  <input id="nav-toggle" type="checkbox"/>

  <div class="layout">
    <aside class="sidebar">
      <div class="nav-title">Menu</div>
      <nav class="nav">
        <a href="/dashboard">
          <svg viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5v9a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z"/></svg>
          Home
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M20 20l-3.5-3.5"/></svg>
          Search
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><path d="M7 20a4 4 0 1 1 10 0"/><circle cx="12" cy="8" r="3"/><path d="M2 20a4 4 0 0 1 6-3.46"/><path d="M22 20a4 4 0 0 0-6-3.46"/></svg>
          Groups
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><path d="M2 20a6 6 0 0 1 12 0"/><path d="M10 20a6 6 0 0 1 12 0"/></svg>
          Friends
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 3-6.7"/><path d="M3 3v6h6"/><path d="M12 7v6l4 2"/></svg>
          History
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><path d="M3 7h14a4 4 0 0 1 4 4v2a4 4 0 0 1-4 4H3z"/><path d="M17 11h4v2h-4z"/></svg>
          Wallet
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><path d="M6 8a6 6 0 1 1 12 0v5l2 3H4l2-3z"/><path d="M9 19a3 3 0 0 0 6 0"/></svg>
          Notifications
        </a>
        <a href="#">
          <svg viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a2 2 0 0 1-2.9 2.9l-.1-.1a1 1 0 0 0-1.1-.2 1 1 0 0 0-.6.9V21a2 2 0 0 1-4 0v-.1a1 1 0 0 0-.6-.9 1 1 0 0 0-1.1.2l-.1.1a2 2 0 1 1-2.9-2.9l.1-.1a1 1 0 0 0 .2-1.1 1 1 0 0 0-.9-.6H3a2 2 0 0 1 0-4h.1a1 1 0 0 0 .9-.6 1 1 0 0 0-.2-1.1l-.1-.1a2 2 0 1 1 2.9-2.9l.1.1a1 1 0 0 0 1.1.2h.1c.5-.2.8-.6.8-1.1V3a2 2 0 0 1 4 0v.1c0 .5.3.9.8 1.1h.1a1 1 0 0 0 1.1-.2l.1-.1a2 2 0 1 1 2.9 2.9l-.1.1a1 1 0 0 0-.2 1.1v.1c.2.5.6.8 1.1.8H21a2 2 0 0 1 0 4h-.1a1 1 0 0 0-.9.6z"/></svg>
          Settings
        </a>
        <a class="active" href="/add-expense">
          <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          Add Expense
        </a>
      </nav>
    </aside>

    <main class="main">
      <section class="panel" style="max-width: 920px; margin-inline:auto;">
        <h1>Add Expense</h1>
        <p class="muted">Enter details below to add a new expense.</p>

        <form id="expenseForm" onsubmit="return false;">

          <label>Is this a group expense? <span class="req">*</span></label>
          <div class="split-row">
            <label>
              <input type="radio" name="is_group_expense" value="yes" checked />
              <span>Yes</span>
            </label>
            <label>
              <input type="radio" name="is_group_expense" value="no" />
              <span>No</span>
            </label>
          </div>

          <div id="groupSection">
            <label for="group">Group <span class="req">*</span></label>
            <select id="group" name="group" required>
              <option value="" disabled selected>Select a group...</option>
            </select>

            <label for="memberBtn" style="margin-top:12px;">Members <span class="req">*</span></label>
            <button id="memberBtn" class="dd-btn" type="button" disabled aria-expanded="false">
              Choose a group first.
            </button>

            <div id="memberPanel" class="dd-panel hidden" role="dialog" aria-label="Select members">
              <div class="dd-head">
                <label class="dd-check">
                  <input type="checkbox" id="memberSelectAll" />
                  <span>Select all</span>
                </label>
                <input id="memberSearch" class="dd-search" type="text" placeholder="Search members…">
              </div>

              <div id="memberList" class="dd-list" role="listbox" aria-multiselectable="true"></div>

              <div class="dd-actions">
                <button type="button" id="memberDone" class="dd-primary">Done</button>
                <button type="button" id="memberClear" class="dd-link">Clear</button>
              </div>
            </div>

            <div id="memberHiddenInputs" class="hidden"></div>
          </div>

          <div id="friendSection" class="hidden">
            <label for="friendSelect">Friends <span class="req">*</span></label>
            <select id="friendSelect" name="friend">
              <option value="" disabled selected>Select a friend...</option>
            </select>
            <div class="muted" style="font-size:0.85rem; margin-top:4px;">
              Missing someone? You can manage friends from the Friends page.
            </div>
          </div>

          <label for="date">Date <span class="req">*</span></label>
          <input id="date" name="date" type="date" required />

          <label for="expense_type">Expense Type <span class="req">*</span></label>
          <select id="expense_type" name="expense_type" required>
            <option value="" disabled selected>Select a type...</option>
            <option value="food">Food</option>
            <option value="groceries">Groceries</option>
            <option value="rent">Rent</option>
            <option value="utilities">Utilities</option>
            <option value="transportation">Transportation</option>
            <option value="entertainment">Entertainment</option>
            <option value="shopping">Shopping</option>
            <option value="health">Health</option>
            <option value="travel">Travel</option>
            <option value="household">Household</option>
            <option value="other">Other</option>
          </select>

          <label for="description">Description (optional)</label>
          <input id="description" name="description" type="text" placeholder="e.g. Pizza Night" />

          <label for="total">Total Amount <span class="req">*</span></label>
          <div class="money-field">
            <span class="prefix" aria-hidden="true">$</span>
            <input id="total" name="total" type="number" step="0.01" inputmode="decimal"
                   placeholder="0.00"
                   aria-label="Total amount in US dollars" required />
          </div>

          <label>Split Type <span class="req">*</span></label>
          <div class="split-row">
            <label>
              <input type="radio" name="split_type" value="equal" checked />
              <span>Equal</span>
            </label>
            <label>
              <input type="radio" name="split_type" value="amount" />
              <span>Custom amounts</span>
            </label>
            <label>
              <input type="radio" name="split_type" value="percentage" />
              <span>Custom percentages</span>
            </label>
          </div>
          <div id="splitError" class="error-text"></div>

          <div id="customAmountSection" class="hidden" style="margin-top:8px;">
            <div class="muted" style="font-size:0.9rem; margin-bottom:4px;">
              Enter each member&rsquo;s share in dollars. Total must add up to the amount.
            </div>
            <div id="customAmountRows"></div>
            <div id="amountRemaining" class="status-badge"></div>
          </div>

          <div id="customPercentageSection" class="hidden" style="margin-top:8px;">
            <div class="muted" style="font-size:0.9rem; margin-bottom:4px;">
              Enter each member&rsquo;s share in percent. All percentages must add up to 100.
            </div>
            <div id="customPercentageRows"></div>
            <div id="percentageRemaining" class="status-badge"></div>
          </div>

          <div class="actions">
            <button class="btn primary" disabled>Save Expense</button>
            <div id="saveHint" class="error-text"></div>
          </div>
        </form>
      </section>
    </main>
  </div>

  <script>
    /* Prefill date and block future dates */
    (function presetToday(){
      const d = document.getElementById('date');
      if (!d) return;
      const t = new Date();
      const mm = String(t.getMonth() + 1).padStart(2, '0');
      const dd = String(t.getDate()).padStart(2, '0');
      const todayStr = `${t.getFullYear()}-${mm}-${dd}`;
      d.value = todayStr;
      d.max = todayStr;
    })();

    async function fetchJson(url){
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return res.json();
    }
    function normalizeRows(payload){
      return Array.isArray(payload) ? payload : (Array.isArray(payload?.data) ? payload.data : []);
    }

    (async function loadGroups(){
      const sel = document.getElementById('group');
      if (!sel) return;
      const addOpt = (value, label, disabled=false) => {
        const o = document.createElement('option');
        o.value = value; o.textContent = label; o.disabled = disabled;
        sel.appendChild(o);
      };
      try{
        const data = normalizeRows(await fetchJson('/groups'));
        if (!data.length){
          addOpt('', 'No groups found', true);
          sel.value=''; sel.disabled=true;
          return;
        }
        data.forEach(g=>{
          const id = g.id ?? g.group_id ?? g.uuid ?? g.pk;
          const name = g.name ?? g.group_name ?? g.title ?? `Group ${id}`;
          if (id != null) addOpt(String(id), String(name));
        });
      }catch(err){
        console.error('Failed to load groups:', err);
        addOpt('', 'Error loading groups', true);
        sel.value=''; sel.disabled=true;
      }
    })();

    (function membersDropdown(){
      const groupSel   = document.getElementById('group');
      const btn        = document.getElementById('memberBtn');
      const panel      = document.getElementById('memberPanel');
      const list       = document.getElementById('memberList');
      const search     = document.getElementById('memberSearch');
      const selectAll  = document.getElementById('memberSelectAll');
      const done       = document.getElementById('memberDone');
      const clear      = document.getElementById('memberClear');
      const hiddenWrap = document.getElementById('memberHiddenInputs');

      const customAmountSection = document.getElementById('customAmountSection');
      const customPercentageSection = document.getElementById('customPercentageSection');
      const customAmountRows = document.getElementById('customAmountRows');
      const customPercentageRows = document.getElementById('customPercentageRows');
      const amountRemainingEl = document.getElementById('amountRemaining');
      const percentageRemainingEl = document.getElementById('percentageRemaining');

      const splitRadios = document.querySelectorAll('input[name="split_type"]');
      const totalInput = document.getElementById('total');
      const saveBtn = document.querySelector('.btn.primary');
      const saveHint = document.getElementById('saveHint');

      let currentMembers = [];
      let open = false;

      let amountTotalsValid = true;
      let percentageTotalsValid = true;

      function getCheckedIds(){
        return [...list.querySelectorAll('.memberChk:checked')].map(c=>c.value);
      }
      function setCheckedByIds(ids){
        const idSet = new Set(ids.map(String));
        list.querySelectorAll('.memberChk').forEach(c => { c.checked = idSet.has(c.value); });
        syncSelectAll();
        syncSummary();
        mirrorHiddenInputs();
      }

      function updateSaveState(){
        const selected = [...splitRadios].find(r => r.checked)?.value || 'equal';
        let ok = true;
        if (selected === 'amount') ok = amountTotalsValid;
        if (selected === 'percentage') ok = percentageTotalsValid;

        if (saveBtn){
          saveBtn.disabled = !ok;
        }
        if (saveHint){
          if (!ok){
            saveHint.textContent = 'Fix split totals to enable saving.';
            saveHint.style.display = 'block';
          } else {
            saveHint.textContent = '';
            saveHint.style.display = 'none';
          }
        }
      }

      function updateAmountRemaining() {
        if (!amountRemainingEl) return;
        const selected = [...splitRadios].find(r => r.checked)?.value || 'equal';

        amountRemainingEl.style.display = 'none';
        amountRemainingEl.classList.remove('under', 'over');
        amountRemainingEl.innerHTML = '';

        if (selected !== 'amount') {
          amountTotalsValid = true;
          updateSaveState();
          return;
        }

        const total = parseFloat(totalInput?.value || '0');
        const inputs = document.querySelectorAll('.custom-amount-input');

        if (!total || inputs.length === 0) {
          amountTotalsValid = true;
          updateSaveState();
          return;
        }

        let sum = 0;
        inputs.forEach(inp => {
          const v = parseFloat(inp.value || '0');
          if (!isNaN(v)) sum += v;
        });
        const remaining = +(total - sum).toFixed(2);

        const diffValid = Math.abs(remaining) <= 0.01;
        amountTotalsValid = diffValid;

        if (!diffValid){
          amountRemainingEl.style.display = 'block';
          if (remaining > 0){
            amountRemainingEl.classList.add('under');
            amountRemainingEl.innerHTML =
              `+ <strong>$${remaining.toFixed(2)}</strong> remaining`;
          } else if (remaining < 0){
            amountRemainingEl.classList.add('over');
            const over = Math.abs(remaining);
            amountRemainingEl.innerHTML =
              `- <strong>$${over.toFixed(2)}</strong> over`;
          }
        }

        updateSaveState();
      }

      function updatePercentageAmounts() {
        const total = parseFloat(totalInput?.value || '0');
        const pctInputs = document.querySelectorAll('.custom-percentage-input');

        pctInputs.forEach(inp => {
          const id = inp.dataset.memberId;
          const span = document.querySelector(`.percentage-amount[data-member-id="${id}"]`);
          if (!span) return;

          const pct = parseFloat(inp.value || '0');
          if (!total || isNaN(pct)) {
            span.textContent = '$0.00';
          } else {
            const amt = (total * pct) / 100;
            span.textContent = `$${amt.toFixed(2)}`;
          }
        });
      }

      function updatePercentageRemaining() {
        if (!percentageRemainingEl) return;
        const selected = [...splitRadios].find(r => r.checked)?.value || 'equal';

        percentageRemainingEl.style.display = 'none';
        percentageRemainingEl.classList.remove('under', 'over');
        percentageRemainingEl.innerHTML = '';

        const inputs = document.querySelectorAll('.custom-percentage-input');
        if (selected !== 'percentage' || inputs.length === 0) {
          percentageTotalsValid = true;
          updateSaveState();
          updatePercentageAmounts();
          return;
        }

        let sum = 0;
        inputs.forEach(inp => {
          const v = parseFloat(inp.value || '0');
          if (!isNaN(v)) sum += v;
        });
        const remaining = +(100 - sum).toFixed(2);

        const diffValid = Math.abs(remaining) <= 0.01;
        percentageTotalsValid = diffValid;

        if (!diffValid){
          percentageRemainingEl.style.display = 'block';
          if (remaining > 0){
            percentageRemainingEl.classList.add('under');
            percentageRemainingEl.innerHTML =
              `+ <strong>${remaining.toFixed(2)}%</strong> remaining`;
          } else if (remaining < 0){
            percentageRemainingEl.classList.add('over');
            const over = Math.abs(remaining);
            percentageRemainingEl.innerHTML =
              `- <strong>${over.toFixed(2)}%</strong> over`;
          }
        }

        updateSaveState();
        updatePercentageAmounts();
      }

      function buildCustomRows() {
        if (!customAmountRows || !customPercentageRows) return;

        if (!currentMembers.length) {
          customAmountRows.innerHTML = '';
          customPercentageRows.innerHTML = '';
          updateAmountRemaining();
          updatePercentageRemaining();
          updatePercentageAmounts();
          return;
        }

        customAmountRows.innerHTML = currentMembers.map(m => `
          <div style="margin-top:6px; display:flex; align-items:center; gap:10px;">
            <span style="min-width:120px;">${m.name}</span>
            <div class="money-field" style="flex:0 0 160px;">
              <span class="prefix" aria-hidden="true">$</span>
              <input
                type="number"
                class="custom-amount-input"
                data-member-id="${m.id}"
                step="0.01"
                min="0"
                inputmode="decimal"
                placeholder="0.00"
              />
            </div>
          </div>
        `).join('');

        customPercentageRows.innerHTML = currentMembers.map(m => `
          <div style="margin-top:6px; display:flex; align-items:center; gap:10px;">
            <span style="min-width:120px;">${m.name}</span>
            <div style="display:flex; align-items:center; gap:6px; flex:1 1 auto;">
              <input
                type="number"
                class="custom-percentage-input"
                data-member-id="${m.id}"
                step="0.01"
                min="0"
                max="100"
                inputmode="decimal"
                placeholder="0"
                style="width:80px;"
              />
              <span>%</span>
              <span
                class="percentage-amount"
                data-member-id="${m.id}"
                style="margin-left:auto; font-size:0.85rem; color:var(--muted); min-width:80px; text-align:right;"
              >
                $0.00
              </span>
            </div>
          </div>
        `).join('');

        customAmountRows.querySelectorAll('.custom-amount-input').forEach(inp => {
          inp.addEventListener('input', updateAmountRemaining);
        });
        customPercentageRows.querySelectorAll('.custom-percentage-input').forEach(inp => {
          inp.addEventListener('input', () => {
            updatePercentageRemaining();
            updatePercentageAmounts();
          });
        });

        updateAmountRemaining();
        updatePercentageRemaining();
        updatePercentageAmounts();
      }

      function updateSplitSections() {
        const selected = [...splitRadios].find(r => r.checked)?.value || 'equal';
        if (customAmountSection) {
          customAmountSection.classList.toggle('hidden', selected !== 'amount');
        }
        if (customPercentageSection) {
          customPercentageSection.classList.toggle('hidden', selected !== 'percentage');
        }
        updateAmountRemaining();
        updatePercentageRemaining();
        updatePercentageAmounts();
      }

      function renderMembers(rows){
        currentMembers = rows.map(m => ({
          id: String(m.id ?? m.member_id ?? m.user_id),
          name: String(m.name ?? m.full_name ?? m.username ?? `User ${m.id ?? m.member_id ?? m.user_id}`)
        })).filter(m => m.id !== 'null' && m.id !== 'undefined');

        list.innerHTML = currentMembers.map(m => `
          <label class="dd-item">
            <input type="checkbox" class="memberChk" value="${m.id}" />
            <span>${m.name}</span>
          </label>
        `).join('') || `<div class="muted" style="padding:8px;">No members in this group.</div>`;

        selectAll.checked = false;
        syncSummary();
        mirrorHiddenInputs();
        buildCustomRows();
      }

      function mirrorHiddenInputs(){
        hiddenWrap.innerHTML = '';
        getCheckedIds().forEach(id => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'member_ids';
          input.value = id;
          hiddenWrap.appendChild(input);
        });
      }

      function syncSummary(){
        const count = getCheckedIds().length;
        btn.textContent = count ? `${count} selected` : 'Select members';
      }

      function syncSelectAll(){
        const checks = [...list.querySelectorAll('.memberChk')];
        selectAll.checked = checks.length > 0 && checks.every(c=>c.checked);
      }

      function openPanel(){
        panel.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); open = true;
        setTimeout(()=>search.focus(), 0);
      }
      function closePanel(){
        panel.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); open = false;
      }

      async function loadMembersFor(groupId){
        list.innerHTML = `<div class="muted" style="padding:8px;">Loading members…</div>`;
        selectAll.checked = false;
        try{
          const rows = normalizeRows(await fetchJson(`/groups/${groupId}/members`));
          renderMembers(rows);
        }catch(err){
          console.error('Failed to load members:', err);
          list.innerHTML = `<div class="muted" style="padding:8px;">Error loading members.</div>`;
        }
      }

      if (groupSel) {
        groupSel.addEventListener('change', (e)=>{
          const gid = e.target.value;
          if (!gid){
            btn.disabled = true;
            btn.textContent = 'Choose a group first.';
            return;
          }
          btn.disabled = false;
          btn.textContent = 'Select members';
          closePanel();
          loadMembersFor(gid);
        });
      }

      if (btn) {
        btn.addEventListener('click', ()=> open ? closePanel() : openPanel());
      }
      document.addEventListener('click', (e)=>{
        if (!open) return;
        if (e.target === btn || panel.contains(e.target)) return;
        closePanel();
      });
      document.addEventListener('keydown', (e)=>{ if (open && e.key === 'Escape') closePanel(); });

      if (search) {
        search.addEventListener('input', ()=>{
          const q = search.value.toLowerCase();
          [...list.querySelectorAll('.dd-item')].forEach(item=>{
            const name = item.textContent.toLowerCase();
            item.style.display = name.includes(q) ? '' : 'none';
          });
        });
      }

      if (selectAll) {
        selectAll.addEventListener('change', ()=>{
          list.querySelectorAll('.memberChk').forEach(c => c.checked = selectAll.checked);
          syncSummary();
          mirrorHiddenInputs();
        });
      }

      list.addEventListener('change', (e)=>{
        if (!e.target.classList.contains('memberChk')) return;
        syncSelectAll();
        syncSummary();
        mirrorHiddenInputs();
      });

      if (clear) {
        clear.addEventListener('click', ()=>{
          setCheckedByIds([]);
        });
      }
      if (done) {
        done.addEventListener('click', closePanel);
      }

      splitRadios.forEach(radio => {
        radio.addEventListener('change', updateSplitSections);
      });
      updateSplitSections();

      if (totalInput) {
        totalInput.addEventListener('input', ()=>{
          updateAmountRemaining();
          updatePercentageRemaining();
          updatePercentageAmounts();
        });
      }

      updateSaveState();
    })();

    (function groupToggle(){
      const radios = document.querySelectorAll('input[name="is_group_expense"]');
      const groupSection = document.getElementById('groupSection');
      const friendSection = document.getElementById('friendSection');

      if (!radios.length || !groupSection || !friendSection) return;

      function syncMode() {
        const value = [...radios].find(r => r.checked)?.value || 'yes';
        const isGroup = value === 'yes';

        groupSection.classList.toggle('hidden', !isGroup);
        friendSection.classList.toggle('hidden', isGroup);
      }

      radios.forEach(r => r.addEventListener('change', syncMode));
      syncMode();
    })();

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('expenseForm');
      const saveBtn = document.querySelector('.btn.primary');
      const memberHidden = document.getElementById('memberHiddenInputs');
      const memberBtn = document.getElementById('memberBtn');
      const splitError = document.getElementById('splitError');

      if (!form || !saveBtn) return;
      saveBtn.disabled = false;

      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (splitError) {
          splitError.textContent = '';
          splitError.style.display = 'none';
        }

        const groupEl = document.getElementById('group');
        const amountEl = document.getElementById('total');
        const descEl = document.getElementById('description');
        const dateEl = document.getElementById('date');
        const typeEl = document.getElementById('expense_type');

        const group_id = groupEl?.value || null;   //keep UUID as string
        const amount = parseFloat((amountEl?.value || '0'));
        const description = (descEl?.value || '').trim();
        const expense_date = dateEl?.value || '';
        const expense_type = typeEl?.value || null;

        if (expense_date) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const chosen = new Date(expense_date);
          if (chosen > today) {
            alert('Date cannot be in the future.');
            return;
          }
        }
        const memberInputs = memberHidden
          ? [...memberHidden.querySelectorAll('input[name="member_ids"]')]
          : [];
        const member_ids = memberInputs.map(i => i.value);  // use raw UUID strings

        const splitRadio = document.querySelector('input[name="split_type"]:checked');
        const split_type = splitRadio ? splitRadio.value : 'equal';

        let custom_amounts;
        let custom_percentages;

        if (!group_id || !amount || !expense_date || member_ids.length === 0) {
          alert('Please fill all required fields and select at least one member.');
          return;
        }

        if (split_type === 'amount') {
          const amountInputs = document.querySelectorAll('.custom-amount-input');
          const byId = {};
          amountInputs.forEach(inp => {
            const id = inp.dataset.memberId;
            const val = parseFloat(inp.value || '0');
            byId[id] = isNaN(val) ? 0 : val;
          });

          custom_amounts = memberInputs.map(inp => {
            const id = inp.value;
            return byId[id] ?? 0;
          });

          const sumCustom = custom_amounts.reduce((acc, v) => acc + (v || 0), 0);
          const diff = Math.abs(sumCustom - amount);

          if (diff > 0.01) {
            const msg = 'Custom amounts must add up to the total amount.';
            if (splitError) {
              splitError.textContent = msg;
              splitError.style.display = 'block';
            } else {
              alert(msg);
            }
            return;
          }
        }

        if (split_type === 'percentage') {
          const pctInputs = document.querySelectorAll('.custom-percentage-input');
          const byId = {};
          pctInputs.forEach(inp => {
            const id = inp.dataset.memberId;
            const val = parseFloat(inp.value || '0');
            byId[id] = isNaN(val) ? 0 : val;
          });

          custom_percentages = memberInputs.map(inp => {
            const id = inp.value;
            return byId[id] ?? 0;
          });

          const sumPct = custom_percentages.reduce((acc, v) => acc + (v || 0), 0);
          const diffPct = Math.abs(sumPct - 100);

          if (diffPct > 0.01) {
            const msg = 'Custom percentages must add up to 100.';
            if (splitError) {
              splitError.textContent = msg;
              splitError.style.display = 'block';
            } else {
              alert(msg);
            }
            return;
          }
        }

        saveBtn.disabled = true;
        const oldLabel = saveBtn.textContent;
        saveBtn.textContent = 'Saving…';

        try {
          const payload = {
            group_id,
            amount,
            description,
            expense_date,
            member_ids,
            split_type,
            expense_type,
          };

          if (split_type === 'amount') payload.custom_amounts = custom_amounts;
          if (split_type === 'percentage') payload.custom_percentages = custom_percentages;

          const res = await fetch('/expenses/', {
            method: 'POST',
            credentials: "include",
            headers: { 
              'Content-Type': 'application/json', 
              'Accept': 'application/json' 
            },
            body: JSON.stringify(payload)
          });
          const json = await res.json().catch(() => ({}));

          if (!res.ok || !json?.ok) {
            const msg = json?.detail || json?.error || `Save failed (${res.status}).`;
            throw new Error(msg);
          }

          alert('Expense created!');
          form.reset();
          if (memberHidden) memberHidden.innerHTML = '';
          if (memberBtn) memberBtn.textContent = 'Select members';

          window.location.href = '/dashboard';
        } catch (err) {
          console.error(err);
          alert(err.message || 'Save failed. Please try again.');
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = oldLabel;
        }
      });
    });
  </script>
</body>
</html>
