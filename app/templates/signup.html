{% extends "base_public.html" %}

{% block title %}Sign Up | Expense Splitter{% endblock %}

{% block styles %}
<style>
  .auth-shell{
    width:100%;
    max-width:540px;
  }

  .brand{
    text-align:center;
    font-size:2rem;
    font-weight:700;
    margin-bottom:16px;
  }

  .brand span{
    color:var(--green);
  }

  .auth-wrapper{
    width:100%;
    background:var(--card);
    padding:40px 36px;
    border-radius:18px;
    box-shadow:var(--shadow);
  }

  h2{
    margin:0;
    font-size:1.4rem;
    font-weight:600;
    text-align:center;
  }

  p.sub{
    text-align:center;
    margin:6px 0 24px;
    color:var(--muted);
    font-size:.95rem;
  }

  label{
    display:block;
    margin:12px 0 6px;
    font-size:.92rem;
  }

  .req::after{
    content:" *";
    color:#b91c1c;
  }

  input{
    width:100%;
    padding:12px 14px;
    border:1px solid #e5e7eb;
    border-radius:10px;
    font-size:14px;
  }

  .row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:14px;
  }

  .pw-wrap{
    position:relative;
  }

  .eye-btn{
    position:absolute;
    right:12px;
    top:50%;
    transform:translateY(-50%);
    background:none;
    border:none;
    cursor:pointer;
    padding:0;
  }

  .eye-icon{
    width:20px;
    height:20px;
    stroke:currentColor;
    stroke-width:2;
    fill:none;
  }

  .strength{
    display:flex;
    align-items:center;
    gap:10px;
    margin-top:6px;
  }

  .bar{
    flex:1;
    height:8px;
    background:#e5e7eb;
    border-radius:999px;
    overflow:hidden;
  }

  .bar span{
    display:block;
    height:100%;
    width:0;
    background:#b91c1c;
    transition:width .2s;
  }

  .hint{
    font-size:.85rem;
    color:var(--muted);
  }

  .error-text{
    font-size:.85rem;
    color:#b91c1c;
    margin-top:4px;
  }

  .username-msg{
    font-size:.85rem;
    margin-top:4px;
    display:none;
  }

  .username-msg.username-error{
    color:#b91c1c;
  }

  .username-msg.username-ok{
    color:#15803d;
  }

  .btn{
    width:100%;
    margin-top:22px;
    padding:13px;
    background:var(--green);
    color:white;
    font-weight:700;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-size:1rem;
  }

  .btn:hover{
    background:var(--green-600);
  }

  .btn[disabled]{
    opacity:0.6;
    cursor:not-allowed;
    box-shadow:none;
  }

  .alt{
    margin-top:18px;
    text-align:center;
    font-size:.95rem;
  }

  .alt a{
    text-decoration:none;
    color:var(--green-600);
  }

  .banner{
    display:none;
    padding:10px 12px;
    border-radius:8px;
    margin-bottom:16px;
    font-size:.92rem;
  }

  #signup-success{
    background:#d4edda;
    color:#155724;
  }

  #signup-error{
    background:#f8d7da;
    color:#721c24;
  }
</style>
{% endblock %}

{% block content %}
<div class="auth-shell">

  <div class="brand">
    Expense <span>Splitter</span>
  </div>

  <div class="auth-wrapper">
    <h2>Sign up</h2>
    <p class="sub">Provide the information below to set up your account.</p>

    <div id="signup-success" class="banner">
      Account created. Check your email to verify.
    </div>

    <div id="signup-error" class="banner"></div>

    <form id="signup-form">

      <div class="row">
        <div>
          <label class="req" for="first_name">First Name</label>
          <input id="first_name" name="first_name" required>
        </div>

        <div>
          <label class="req" for="last_name">Last Name</label>
          <input id="last_name" name="last_name" required>
        </div>
      </div>

      <input type="hidden" id="full_name" name="name">

      <label class="req" for="email">Email</label>
      <input id="email" name="email" type="email" required>

      <label class="req" for="username">Username</label>
      <input id="username" name="username" required>
      <p id="username-msg" class="username-msg"></p>

      <div class="row">
        <div class="pw-wrap">
          <label class="req" for="password">Password</label>
          <input id="password" name="password" type="password" minlength="8" required>
          <button type="button" class="eye-btn" onclick="togglePw('password', this)">
            <svg class="eye-icon show" viewBox="0 0 24 24">
              <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <svg class="eye-icon hide" viewBox="0 0 24 24" style="display:none">
              <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.8 21.8 0 0 1 5.06-5.94"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
          </button>

          <div class="strength">
            <div class="bar"><span id="pwBar"></span></div>
            <span id="pwLabel" class="hint">weak</span>
          </div>
        </div>

        <div class="pw-wrap">
          <label class="req" for="confirm_password">Confirm Password</label>
          <input id="confirm_password" type="password" minlength="8" required>
          <button type="button" class="eye-btn" onclick="togglePw('confirm_password', this)">
            <svg class="eye-icon show" viewBox="0 0 24 24">
              <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <svg class="eye-icon hide" viewBox="0 0 24 24" style="display:none">
              <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.8 21.8 0 0 1 5.06-5.94"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
          </button>
        </div>
      </div>

      <p id="pw-mismatch" class="error-text" style="display:none;">
        Password and confirmation do not match.
      </p>

      <label class="req" for="dob">Date of Birth</label>
      <input id="dob" name="dob" type="date" required>

      <p class="sub" style="margin-top:14px; font-size:.9rem;">
        By signing up you confirm that you are at least 18 years old.
      </p>

      <button type="submit" id="signup-btn" class="btn" disabled>Sign Up</button>
    </form>

    <div class="alt">
      Already have an account? <a href="/login">Login here</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module" src="/static/js/supabaseClient.js"></script>
<script type="module" src="/static/js/signup.js"></script>

<script>
  // Cache references for validation and username checks
  const form = document.getElementById("signup-form");
  const firstName = document.getElementById("first_name");
  const lastName = document.getElementById("last_name");
  const fullName = document.getElementById("full_name");
  const email = document.getElementById("email");
  const usernameInput = document.getElementById("username");
  const usernameMsg = document.getElementById("username-msg");
  const pw = document.getElementById("password");
  const confirmPw = document.getElementById("confirm_password");
  const dob = document.getElementById("dob");
  const signupBtn = document.getElementById("signup-btn");
  const mismatchMsg = document.getElementById("pw-mismatch");
  const bar = document.getElementById("pwBar");
  const lbl = document.getElementById("pwLabel");

  // Password strength score used to gate signup
  let pwScore = 0;
  // Username validation state
  let usernameOk = false;
  let usernameTimer = null;

  function setUsernameMessage(message, okType) {
    usernameMsg.textContent = message;
    usernameMsg.style.display = "block";
    usernameMsg.classList.remove("username-error", "username-ok");

    if (okType === "ok") {
      usernameMsg.classList.add("username-ok");
    } else {
      usernameMsg.classList.add("username-error");
    }
  }

  // Update full name and revalidate on any input
  form.addEventListener("input", () => {
    fullName.value = firstName.value.trim() + " " + lastName.value.trim();
    validateForm();
  });

  // Username input listener with debounce for availability check
  usernameInput.addEventListener("input", () => {
    usernameOk = false;
    usernameMsg.style.display = "none";
    signupBtn.disabled = true;

    clearTimeout(usernameTimer);
    usernameTimer = setTimeout(checkUsernameAvailability, 400);
  });

  // Enforce minimum age requirement of 18 years and set max attribute
  const today = new Date();
  dob.max = `${today.getFullYear()-18}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;

  // Clamp typed DOB to max allowed date
  dob.addEventListener("input", () => {
    if (!dob.value) {
      validateForm();
      return;
    }
    const maxDate = new Date(dob.max);
    const typed = new Date(dob.value);
    if (typed > maxDate || Number.isNaN(typed.getTime())) {
      dob.value = dob.max;
    }
    validateForm();
  });

  // Toggle password visibility for a specific field
  function togglePw(id, btn){
    const input = document.getElementById(id);
    const show = btn.querySelector(".show");
    const hide = btn.querySelector(".hide");
    const isHidden = input.type === "password";
    input.type = isHidden ? "text" : "password";
    show.style.display = isHidden ? "none" : "block";
    hide.style.display = isHidden ? "block" : "none";
  }

  // Update password strength bar and label on each keystroke
  pw.addEventListener("input", () => {
    let s = 0;
    const v = pw.value;

    if (v.length >= 8) s++;
    if (/[A-Z]/.test(v)) s++;
    if (/[a-z]/.test(v)) s++;
    if (/\d/.test(v)) s++;
    if (/[^A-Za-z0-9]/.test(v)) s++;

    pwScore = s;

    const pct = [0,20,40,60,80,100][s];
    bar.style.width = pct + "%";
    bar.style.background = s < 3 ? "#b91c1c" : s < 4 ? "#f59e0b" : "#15803d";
    lbl.textContent = s < 3 ? "weak" : s < 4 ? "medium" : "strong";

    validateForm();
  });

  // Revalidate whenever confirmation field changes
  confirmPw.addEventListener("input", validateForm);

  async function checkUsernameAvailability() {
    const raw = usernameInput.value.trim();

    if (!raw) {
      usernameOk = false;
      setUsernameMessage("Username is required.", "error");
      validateForm();
      return;
    }

    const pattern = /^[A-Za-z0-9._]+$/;
    if (!pattern.test(raw)) {
      usernameOk = false;
      setUsernameMessage(
        "Only letters, numbers, dot (.) and underscore (_) are allowed.",
        "error"
      );
      validateForm();
      return;
    }

    try {
      const resp = await fetch(`/auth/check-username?username=${encodeURIComponent(raw)}`);
      if (!resp.ok) {
        usernameOk = false;
        setUsernameMessage("Could not validate username.", "error");
        validateForm();
        return;
      }

      const data = await resp.json();
      if (data.available) {
        usernameOk = true;
        setUsernameMessage("Username is available.", "ok");
      } else {
        usernameOk = false;
        setUsernameMessage("Username is already taken. Choose another.", "error");
      }
    } catch (err) {
      console.error("Error checking username", err);
      usernameOk = false;
      setUsernameMessage("Could not validate username.", "error");
    }

    validateForm();
  }

  // Validate all required fields, password strength, match, and username state
  function validateForm(){
    const firstOk = firstName.value.trim() !== "";
    const lastOk = lastName.value.trim() !== "";
    const emailOk = email.value.trim() !== "" && email.checkValidity();
    const usernameFilled = usernameInput.value.trim() !== "";
    const dobOk = dob.value !== "";
    const pwVal = pw.value;
    const confirmVal = confirmPw.value;

    const strongEnough = pwVal.length >= 8 && pwScore >= 3;
    const passwordsMatch = pwVal !== "" && pwVal === confirmVal;

    mismatchMsg.style.display = confirmVal && !passwordsMatch ? "block" : "none";

    const allFieldsFilled =
      firstOk && lastOk && emailOk && usernameFilled && dobOk &&
      pwVal !== "" && confirmVal !== "";

    const formValid = allFieldsFilled && strongEnough && passwordsMatch && usernameOk;

    signupBtn.disabled = !formValid;
  }

  form.addEventListener("submit", (e) => {
    validateForm();
    if (signupBtn.disabled) {
      e.preventDefault();
    }
  });
</script>
{% endblock %}
