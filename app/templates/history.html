{% extends "base.html" %}

{% block title %}History | Expense Splitter{% endblock %}

{% block content %}
<h1>History</h1>
<p>View past expenses and payments. Use the filters to narrow down by group or person.</p>

<!-- Filter section -->
<header>
  <select id="groupFilter">
    <option value="">All groups</option>
  </select>
  <input id="personFilter" placeholder="Filter by person…" />
  <button id="btnApply" type="button">Apply filters</button>
  <button id="btnClear" type="button">Clear</button>
</header>

<!-- Two-column layout -->
<div class="columns">
  <div class="col">
    <h2>Received Payments</h2>
    <ul id="receivedList"></ul>
  </div>
  <div class="col">
    <h2>Paid Expenses</h2>
    <ul id="paidList"></ul>
  </div>
</div>

<!-- Global empty-state message when there is no history at all -->
<p id="globalEmpty" class="empty" style="margin-top: 12px;"></p>
{% endblock %}

{% block scripts %}
<script>
  // References to HTML elements
  const groupEl = document.getElementById("groupFilter");
  const personEl = document.getElementById("personFilter");
  const receivedList = document.getElementById("receivedList");
  const paidList = document.getElementById("paidList");
  const globalEmptyEl = document.getElementById("globalEmpty");

  // Load groups into the dropdown
  async function loadFilters() {
    const r = await fetch("/api/history/groups");
    if (!r.ok) return;

    const data = await r.json();
    groupEl.innerHTML = '<option value="">All groups</option>';
    for (const g of data.groups || []) {
      const opt = document.createElement("option");
      opt.value = g;
      opt.textContent = g;
      groupEl.appendChild(opt);
    }
  }

  // Load history data using filters
  async function loadHistory() {
    const params = new URLSearchParams();
    const g = groupEl.value.trim();
    const p = personEl.value.trim();
    if (g) params.append("group", g);
    if (p) params.append("person", p);

    const r = await fetch("/api/history/?" + params.toString());

    // If unauthorized, show message and stop
    if (r.status === 401) {
      receivedList.innerHTML = "<li class='empty'>You must be logged in to view history.</li>";
      paidList.innerHTML = "";
      globalEmptyEl.textContent = "";
      return;
    }

    const data = await r.json();
    renderLists(data.received || [], data.paid || []);
  }

  // Render the received + paid lists
  function renderLists(received, paid) {
    // Received payments section
    receivedList.innerHTML = "";
    if (!received.length) {
      receivedList.innerHTML = "<li class='empty'>No received payments.</li>";
    } else {
      for (const item of received) {
        const li = document.createElement("li");
        li.textContent = `${item.from} → you • $${item.amount} • ${item.group}`;
        receivedList.appendChild(li);
      }
    }

    // Paid expenses section
    paidList.innerHTML = "";
    if (!paid.length) {
      paidList.innerHTML = "<li class='empty'>No paid expenses.</li>";
    } else {
      for (const item of paid) {
        const li = document.createElement("li");
        li.textContent = `You paid ${item.to} • $${item.amount} • ${item.group}`;
        paidList.appendChild(li);
      }
    }

    // Global empty-state if BOTH lists are empty
    if (!received.length && !paid.length) {
      globalEmptyEl.textContent =
        "No history yet. Your past expenses and payments will appear here.";
    } else {
      globalEmptyEl.textContent = "";
    }
  }

  // Button handlers
  document.getElementById("btnApply").addEventListener("click", loadHistory);
  document.getElementById("btnClear").addEventListener("click", () => {
    groupEl.value = "";
    personEl.value = "";
    loadHistory();
  });

  // Initial load
  loadFilters().then(loadHistory);
</script>
{% endblock %}
