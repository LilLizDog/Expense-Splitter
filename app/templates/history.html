{% extends "base.html" %}

{% block title %}History | Expense Splitter{% endblock %}

{% block content %}
<div class="page">
  <div class="page-header">
    <div>
      <h1 class="page-title">History</h1>
      <p class="page-subtitle">
        See expenses you created and expenses others created for you.
      </p>
    </div>
  </div>

  <!-- Filters card -->
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Filters</h2>
    </div>
    <div class="card-body">
      <div class="history-filters">
        <div class="field">
          <span class="field-label">Group</span>
          <select id="groupFilter">
            <option value="">All groups</option>
          </select>
        </div>

        <div class="field">
          <span class="field-label">Person</span>
          <input
            id="personFilter"
            placeholder="Filter by creator..."
            type="text"
          />
        </div>

        <div class="field">
          <span class="field-label">Type</span>
          <select id="typeFilter">
            <option value="">All types</option>
            <option value="credit">Credit</option>
            <option value="debit">Debit</option>
          </select>
        </div>

        <div class="field history-filter-actions">
          <button id="btnApply" type="button" class="btn-primary">
            Apply filters
          </button>
          <button id="btnClear" type="button" class="btn-secondary">
            Clear
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Table-style history -->
  <section class="card" style="margin-top: 18px;">
    <div class="card-header">
      <h2 class="card-title">Recent history</h2>
    </div>
    <div class="card-body">
      <table class="history-table">
        <thead>
          <tr>
            <th class="col-date">Date</th>
            <th class="col-desc">Description</th>
            <th class="col-amount">Amount</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
      <p id="globalEmpty" class="history-empty"></p>

      <div id="historyPagination" class="history-pagination">
        <button id="pagePrev" class="page-btn" type="button">
          ‹
        </button>
        <span id="pageInfo"></span>
        <button id="pageNext" class="page-btn" type="button">
          ›
        </button>
      </div>
    </div>
  </section>
</div>

<style>
  .history-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: flex-end;
  }

  .history-filters .field {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 160px;
  }

  .history-filters .field-label {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--muted);
  }

  .history-filters select,
  .history-filters input {
    padding: 8px 10px;
    border-radius: var(--radius);
    border: 1px solid #d1d5db;
    font-size: 0.9rem;
    outline: none;
  }

  .history-filters select:focus,
  .history-filters input:focus {
    border-color: var(--green);
    box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.18);
  }

  .history-filter-actions {
    flex-direction: row;
    gap: 8px;
  }

  .btn-primary {
    padding: 8px 14px;
    border-radius: var(--radius);
    border: none;
    background: var(--green);
    color: #ffffff;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    box-shadow: var(--shadow);
  }

  .btn-primary:hover {
    background: var(--green-600);
  }

  .btn-secondary {
    padding: 8px 14px;
    border-radius: var(--radius);
    border: 1px solid #e5e7eb;
    background: #f3f4f6;
    color: var(--black);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
  }

  .btn-secondary:hover {
    background: #e5e7eb;
  }

  .history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .history-table th,
  .history-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
  }

  .history-table th {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .col-date {
    width: 120px;
    white-space: nowrap;
  }

  .col-amount {
    width: 120px;
    text-align: right;
  }

  .amount-positive {
    color: var(--green-600);
    font-weight: 600;
  }

  .amount-negative {
    color: var(--red);
    font-weight: 600;
  }

  .history-empty {
    margin-top: 12px;
    font-size: 0.9rem;
    color: var(--muted);
    text-align: center;
  }

  .history-name {
    color: var(--green-600);
    font-weight: 600;
  }

  .history-pagination {
    margin-top: 10px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: var(--muted);
  }

  .page-btn {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background: #ffffff;
    cursor: pointer;
  }

  .page-btn:disabled {
    opacity: 0.45;
    cursor: default;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  // Number of rows per page for the history table
  const ROWS_PER_PAGE = 10;

  // Global state for all items and current page
  let allItems = [];
  let currentPage = 1;

  // Cache DOM elements used for filters and table rendering
  const groupEl = document.getElementById("groupFilter");
  const personEl = document.getElementById("personFilter");
  const typeEl = document.getElementById("typeFilter");
  const historyBody = document.getElementById("historyBody");
  const globalEmptyEl = document.getElementById("globalEmpty");
  const pagePrev = document.getElementById("pagePrev");
  const pageNext = document.getElementById("pageNext");
  const pageInfo = document.getElementById("pageInfo");

  // Format a date string as MM/DD/YYYY for display
  function formatDate(value) {
    if (!value) return "";
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return value;
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const yyyy = d.getFullYear();
    return `${mm}/${dd}/${yyyy}`;
  }

  // Load group filter options from backend
  async function loadFilters() {
    const r = await fetch("/api/history/groups");
    if (!r.ok) return;

    const data = await r.json();
    groupEl.innerHTML = '<option value="">All groups</option>';
    for (const g of data.groups || []) {
      const opt = document.createElement("option");
      opt.value = g;
      opt.textContent = g;
      groupEl.appendChild(opt);
    }
  }

  // Fetch history based on current filters
  async function loadHistory() {
    const params = new URLSearchParams();
    const g = groupEl.value.trim();
    const p = personEl.value.trim();

    if (g) params.append("group", g);
    if (p) params.append("person", p);

    const r = await fetch("/api/history/?" + params.toString());

    if (r.status === 401) {
      historyBody.innerHTML = "";
      globalEmptyEl.textContent = "You must be logged in to view history.";
      allItems = [];
      updatePaginationInfo();
      return;
    }

    const data = await r.json();
    buildItems(data.received || [], data.paid || []);
  }

  // Combine arrays from server and apply client side filtering and 0 hiding
  function buildItems(received, paid) {
    const items = [];

    // Received entries are expenses you are a participant in
    for (const item of received) {
      const amt = Number(item.amount || 0);
      if (amt === 0) continue; // Skip zero amount entries
      items.push({
        kind: "received",
        date: item.date,
        amount: amt,
        group: item.group || "",
        creatorName: item.creator_name || "Someone",
      });
    }

    // Paid entries are expenses you created
    for (const item of paid) {
      const amt = Number(item.amount || 0);
      if (amt === 0) continue; // Skip zero amount entries
      items.push({
        kind: "paid",
        date: item.date,
        amount: amt,
        group: item.group || "",
        creatorName: item.creator_name || "",
      });
    }

    // Sort newest first by date
    items.sort((a, b) => new Date(b.date) - new Date(a.date));

    // Apply type filter (credit or debit) on the sign of amount
    const typeFilter = typeEl.value.trim();
    let filtered = items;
    if (typeFilter === "credit") {
      filtered = items.filter((i) => i.amount > 0);
    } else if (typeFilter === "debit") {
      filtered = items.filter((i) => i.amount < 0);
    }

    allItems = filtered;
    currentPage = 1;
    renderPage();
  }

  // Render one page of history from allItems
  function renderPage() {
    historyBody.innerHTML = "";

    if (!allItems.length) {
      globalEmptyEl.textContent =
        "No history yet. Expenses you create or are added to will appear here.";
      updatePaginationInfo();
      return;
    }

    globalEmptyEl.textContent = "";

    const totalPages = Math.max(1, Math.ceil(allItems.length / ROWS_PER_PAGE));
    if (currentPage > totalPages) {
      currentPage = totalPages;
    }

    const start = (currentPage - 1) * ROWS_PER_PAGE;
    const end = start + ROWS_PER_PAGE;
    const pageItems = allItems.slice(start, end);

    for (const item of pageItems) {
      const tr = document.createElement("tr");

      // Date column
      const tdDate = document.createElement("td");
      tdDate.textContent = formatDate(item.date);
      tr.appendChild(tdDate);

      // Description column
      const tdDesc = document.createElement("td");
      let descHtml;
    if (item.kind === "received") {
      const creator = `<span class="history-name">${item.creatorName}</span>`;
      if (item.group) {
        descHtml =
          `${creator} created an expense for ` +
          `<span class="history-name">you</span> in `
          + `"${item.group}"`;
      } else {
        descHtml =
          `${creator} created an expense for ` +
          `<span class="history-name">you</span>`;
      }
    } else {
      const you = `<span class="history-name">You</span>`;
      if (item.group) {
        descHtml = `${you} created an expense in "${item.group}"`;
      } else {
        descHtml = `${you} created an expense`;
      }
    }

      tdDesc.innerHTML = descHtml;
      tr.appendChild(tdDesc);

      // Amount column
      const tdAmount = document.createElement("td");
      tdAmount.className = "col-amount";
      const amt = item.amount;
      const absAmt = Math.abs(amt).toFixed(2);
      const sign = amt > 0 ? "+" : amt < 0 ? "-" : "";
      tdAmount.textContent = `${sign}$${absAmt}`;
      if (amt > 0) {
        tdAmount.classList.add("amount-positive");
      } else if (amt < 0) {
        tdAmount.classList.add("amount-negative");
      }
      tr.appendChild(tdAmount);

      historyBody.appendChild(tr);
    }

    updatePaginationInfo();
  }

  // Update pagination controls and text
  function updatePaginationInfo() {
    const totalPages = Math.max(
      1,
      Math.ceil(allItems.length / ROWS_PER_PAGE) || 1
    );
    const hasItems = allItems.length > 0;

    if (!hasItems) {
      pageInfo.textContent = "";
      pagePrev.disabled = true;
      pageNext.disabled = true;
      return;
    }

    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    pagePrev.disabled = currentPage <= 1;
    pageNext.disabled = currentPage >= totalPages;
  }

  // Pagination button handlers
  pagePrev.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage -= 1;
      renderPage();
    }
  });

  pageNext.addEventListener("click", () => {
    const totalPages = Math.max(
      1,
      Math.ceil(allItems.length / ROWS_PER_PAGE)
    );
    if (currentPage < totalPages) {
      currentPage += 1;
      renderPage();
    }
  });

  // Wire filter buttons
  document
    .getElementById("btnApply")
    .addEventListener("click", loadHistory);

  document.getElementById("btnClear").addEventListener("click", () => {
    groupEl.value = "";
    personEl.value = "";
    typeEl.value = "";
    loadHistory();
  });

  // Initial load
  loadFilters().then(loadHistory);
</script>
{% endblock %}
