{% extends "base.html" %}

{% block title %}Settings | Expense Splitter{% endblock %}

{% block styles %}
<style>
  main {
    padding: 24px;
    max-width: 640px;
    margin-inline: auto;
  }

  h1 {
    margin-bottom: 12px;
  }

  .section {
    margin-top: 20px;
    padding: 16px;
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    background: var(--card);
  }

  label {
    display: block;
    margin-bottom: 8px;
  }

  .row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
    gap: 12px;
  }

  select,
  input[type="checkbox"] {
    padding: 6px 8px;
  }

  .status {
    margin-top: 10px;
    color: #555;
    font-size: 14px;
  }

  .theme-row {
    align-items: flex-start;
  }

  .theme-label {
    font-weight: 600;
    white-space: nowrap;
  }

  .theme-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .theme-card {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 130px;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid var(--border-subtle);
    background: var(--card);
    cursor: pointer;
    font-size: 13px;
    transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
  }

  .theme-card:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }

  .theme-card.selected {
    border-color: var(--green-600);
    box-shadow: 0 0 0 1px rgba(21, 128, 61, 0.18);
  }

  .theme-swatch {
    width: 100%;
    height: 28px;
    border-radius: 8px;
    margin-bottom: 6px;
    border: 1px solid rgba(0, 0, 0, 0.06);
  }

  .theme-swatch-light {
    background: linear-gradient(135deg, #f6f7f8 0%, #ffffff 100%);
  }

  .theme-swatch-forest {
    background: linear-gradient(135deg, #e8f5ec 0%, #ffffff 100%);
  }

  .theme-name {
    font-weight: 600;
    margin-bottom: 2px;
  }

  .theme-desc {
    font-size: 12px;
    color: var(--muted);
  }
</style>
{% endblock %}

{% block content %}
<main>
  <h1>Settings</h1>
  <p>Update your app preferences. These are saved to your account and applied automatically.</p>

  <!-- Notification section -->
  <div class="section">
    <h2>Notifications</h2>
    <div class="row">
      <span>Enable notifications</span>
      <input type="checkbox" id="notifyToggle" />
    </div>
  </div>

  <!-- Appearance section -->
  <div class="section">
    <h2>Appearance</h2>

    <!-- Theme cards -->
    <div class="row theme-row">
      <div class="theme-label">Theme</div>
      <div class="theme-grid">
        <button type="button" class="theme-card" data-theme="light">
          <div class="theme-swatch theme-swatch-light"></div>
          <div class="theme-name">Light</div>
          <div class="theme-desc">Default neutral look.</div>
        </button>

        <button type="button" class="theme-card" data-theme="forest">
          <div class="theme-swatch theme-swatch-forest"></div>
          <div class="theme-name">Forest</div>
          <div class="theme-desc">Soft green background.</div>
        </button>
      </div>
    </div>

    <!-- Font size dropdown -->
    <div class="row">
      <label for="fontSelect">Font size</label>
      <select id="fontSelect">
        <option value="normal">Normal</option>
        <option value="large">Large</option>
        <option value="xlarge">Extra large</option>
      </select>
    </div>
  </div>

  <!-- Status shown when settings have been saved -->
  <p class="status" id="status"></p>
</main>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Basic elements
    const notifyEl = document.getElementById("notifyToggle");
    const fontEl = document.getElementById("fontSelect");
    const statusEl = document.getElementById("status");
    const themeCards = document.querySelectorAll(".theme-card");

    // Use global helpers from base.html
    const applyTheme = window.applyTheme || function () {};
    const applyFont = window.applyFont || function () {};

    // Track current theme name
    let currentTheme = "light";

    /**
     * Mark the chosen card as selected
     */
    function selectThemeCard(theme) {
      themeCards.forEach(card => {
        const t = card.dataset.theme;
        card.classList.toggle("selected", t === theme);
      });
    }

    /**
     * Load settings from backend and sync UI
     */
    async function loadSettings() {
      try {
        const r = await fetch("/api/settings/");
        if (!r.ok) {
          console.error("Error loading settings");
          return;
        }
        const data = await r.json();

        notifyEl.checked = data.notifications_enabled;
        currentTheme = data.theme || "light";
        const fontSize = data.font_size || "normal";

        selectThemeCard(currentTheme);
        fontEl.value = fontSize;

        // Global base.html already calls applyTheme/applyFont on load,
        // but calling them again keeps this page in sync.
        applyTheme(currentTheme);
        applyFont(fontSize);
      } catch (err) {
        console.error("Failed to load settings", err);
      }
    }

    /**
     * Save settings to backend
     */
    async function saveSettings() {
      const payload = {
        notifications_enabled: notifyEl.checked,
        theme: currentTheme,
        font_size: fontEl.value
      };

      try {
        const r = await fetch("/api/settings/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (r.ok) {
          statusEl.textContent = "Settings saved.";
          setTimeout(() => {
            statusEl.textContent = "";
          }, 2000);
        } else {
          statusEl.textContent = "Error saving settings.";
        }
      } catch (err) {
        console.error("Failed to save settings", err);
        statusEl.textContent = "Error saving settings.";
      }
    }

    // Notification toggle
    notifyEl.addEventListener("change", () => {
      saveSettings();
    });

    // Font size change
    fontEl.addEventListener("change", () => {
      applyFont(fontEl.value);
      saveSettings();
    });

    // Theme card clicks
    themeCards.forEach(card => {
      card.addEventListener("click", () => {
        const theme = card.dataset.theme;
        currentTheme = theme;
        selectThemeCard(theme);
        applyTheme(theme);
        saveSettings();
      });
    });

    // Initial load
    loadSettings();
  });
</script>
{% endblock %}
