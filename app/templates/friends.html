{% extends "base.html" %}

{% block title %}Friends - Expense Splitter{% endblock %}

{% block styles %}
<style>
  body { margin: 0; } /* base.html already handles most styling */

  header { 
    display:flex; 
    gap:8px; 
    align-items:center; 
    flex-wrap:wrap; 
    margin: 12px 0; 
  }

  input, select, button { padding: 8px; }
  .pill { 
    padding: 2px 8px; 
    border-radius: 999px; 
    background:#eee; 
    font-size: 12px; 
    margin-left: 8px; 
  }

  ul { padding-left: 18px; }
  form { 
    display:flex; 
    gap:8px; 
    flex-wrap:wrap; 
    margin-top: 8px; 
  }
</style>
{% endblock %}

{% block content %}

<h1>Friends <span id="count" class="pill"></span></h1>

<header>
  <input id="q" placeholder="Search name…" />
  <select id="group"><option value="">All groups</option></select>
  <button id="btnSearch">Search</button>
  <button id="btnClear" type="button">Clear</button>
</header>

<form id="addForm">
  <input id="name" placeholder="New friend name" required />
  <input id="newGroup" placeholder="Group (e.g., Roommates)" required />
  <button type="submit">Add Friend</button>
</form>

<ul id="list"></ul>

{% endblock %}

{% block scripts %}
<script>
// Highlight sidebar if /friends is added later
const link = document.querySelector('.nav a[href="/friends"]');
if (link) link.classList.add("active");

const listEl = document.getElementById("list");
const qEl = document.getElementById("q");
const groupEl = document.getElementById("group");
const countEl = document.getElementById("count");

// Load groups from backend
async function loadGroups() {
  const r = await fetch("/api/friends/groups");
  const data = await r.json();

  groupEl.innerHTML = '<option value="">All groups</option>';
  for (const g of data.groups) {
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    groupEl.appendChild(opt);
  }
}

// Load & filter friends list
async function loadFriends() {
  const params = new URLSearchParams();
  const qv = qEl.value.trim();
  const gv = groupEl.value.trim();

  if (qv) params.append("q", qv);
  if (gv) params.append("group", gv);

  const r = await fetch("/api/friends/?" + params.toString());
  const data = await r.json();
  render(data.friends);
}

function render(items) {
  listEl.innerHTML = "";
  countEl.textContent = items.length + " total";

  for (const f of items) {
    const li = document.createElement("li");
    li.textContent = `${f.name} — ${f.group}`;
    listEl.appendChild(li);
  }
}

// Button handlers
document.getElementById("btnSearch").addEventListener("click", loadFriends);

document.getElementById("btnClear").addEventListener("click", () => {
  qEl.value = "";
  groupEl.value = "";
  loadFriends();
});

// Add friend form
document.getElementById("addForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("name").value.trim();
  const group = document.getElementById("newGroup").value.trim();
  if (!name || !group) return;

  const r = await fetch("/api/friends/", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ name, group })
  });

  if (r.ok) {
    document.getElementById("name").value = "";
    document.getElementById("newGroup").value = "";
    await loadGroups();
    await loadFriends();
  } else {
    alert("Failed to add friend");
  }
});

// Initial load
loadGroups().then(loadFriends);
</script>
{% endblock %}
